Providing provenance for a RESTful service
==========================================

This is an example of how a a RESTful service, implemented using [JAX-RS and CXF](http://cxf.apache.org/docs/jax-rs-basics.html), can expose [provenance](http://www.w3.org/TR/prov-overview/) of the resources it exposes. 

There are two branches in this project on https://github.com/stain/paq:
* *master* - REST service that can say hello, and return provenance of greeting
* *paq* - REST service that also provides link between greeting and its provenance

To compile/run, you will need Java and [Maven](http://maven.apache.org/download.cgi):

    PS C:\users\stain\src\paq> mvn clean jetty:run
    [INFO] Scanning for projects...
    [INFO]
    [INFO] ------------------------------------------------------------------------
    [INFO] Building Example PROV-AQ usage 0.1-SNAPSHOT
    [INFO] ------------------------------------------------------------------------
    (..)    
    2013-03-25 15:39:09.419:INFO::Started SelectChannelConnector@0.0.0.0:8080
    [INFO] Started Jetty Server
    [INFO] Starting scanner at interval of 10 seconds.

The base URI should be http://localhost:8080/paq/ unless you modified the port with <code>mvn -Djetty.port=9999</code>
    
Check the HelloWorld REST service is working using your favourite HTTP client (e.g. browser or curl in a new terminal window). 

    PS C:\Users\stain\src\paq> curl http://localhost:8080/paq/hello/Alice
    Hello, Alice

You may replace *Alice* with any name, as long as it is URI escaped:

    PS C:\Users\stain\src\paq> curl http://localhost:8080/paq/hello/Joe%20Bloggs
    Hello, Joe Bloggs

Provenance resource
-------------------

This example service provide [provenance](http://www.w3.org/TR/prov-overview/),
using the [PROV-N](http://www.w3.org/TR/prov-n/) format:

    PS C:\Users\stain\src\paq> curl -i http://localhost:8080/paq/provenance/hello/Alice
    HTTP/1.1 200 OK
    Content-Type: text/provenance-notation
    Date: Mon, 25 Mar 2013 15:41:02 GMT
    Content-Length: 305
    Server: Jetty(6.1.26)
    
    document
      prefix hello <http://localhost:8080/paq/hello/>
      prefix app <http://localhost:8080/paq/>
      entity(hello:Alice)
      wasDerivedFrom(hello:Alice, name)
      entity(name, [ prov:value="Alice" ])
      agent(app:hello, [ prov:type=prov:SoftwareAgent ])
      wasAttributedTo(hello:Alice, app:hello)
    endDocument
    

Note that we used the <code>-i</code> parameter above to verify that the correct media-type [text/provenance-notation](http://www.iana.org/assignments/media-types/text/provenance-notation) was returned.

This provenance says that the resource <http://localhost:8080/paq/hello/Alice> was derived from a name with value "Alice", and made by the (web) service <http://localhost:8080/paq/hello>. 

This PROV-N trace is generated by <code>HelloWorld.helloProvenance()</code> by filling in the URIs and name in the template src/main/resources/provTemplate.txt - a more detailed provenance trace might include things like timestamps and details about who provided the name.   


Locating provenance
-------------------

A restful client who has requested <http://localhost:8080/paq/hello/Alice> will not magically know that there is a provenance trace at <http://localhost:8080/paq/provenance/hello/Alice> - the URI for the provenance resource could just as well have been say <http://localhost:8080/about/history/1337>. 

Rather than for each publisher to invent specific ways to locate the provenance resource, the W3C [PROV-AQ](http://www.w3.org/TR/prov-aq/) Note suggests a common way to find the provenance resource by using HTTP <code>Link:</code> headers according to [RFC5988](http://tools.ietf.org/html/rfc5988)   


Specifically, PAQ says that a [resource accessed by HTTP](http://www.w3.org/TR/2013/WD-prov-aq-20130312/#resource-accessed-by-http) can 
describe its provenance trace by adding a <code>Link}} header with the relation "http://www.w3.org/ns/prov#has_provenance". So in our case, this can be achieved with:

    Link: <http://localhost:8080/paq/provenance/hello/Alice>; rel="http://www.w3.org/ns/prov#has_provenance"


OK, so how do we provide this Link header? Our existing greeting is
quite simple thanks to [JAX-RS and CXF](http://cxf.apache.org/docs/jax-rs-basics.html):

    @GET
    @Path("hello/{name}")
    @Produces("text/plain")
    public String hello(@PathParam("name") String name) {
        String greeting = "Hello, " + name + "\n";
        return greeting;
    }


Our provenance method is a bit more complicated as it [generates 
the absolute URIs](http://cxf.apache.org/docs/jax-rs-basics.html#JAX-RSBasics-URIcalculationusingUriInfoandUriBuilder) for the greeting resource (depending on the name parameter) and then build the PROV-N trace - here using a simple [MessageFormat](http://docs.oracle.com/javase/7/docs/api/java/text/MessageFormat.html) template.


    @GET
    @Path("provenance/hello/{name}")
    @Produces("text/provenance-notation")
    public String helloProvenance(@PathParam("name") String name,
            @Context UriInfo ui) throws IOException {
        // Get our absolute URI
        // See http://cxf.apache.org/docs/jax-rs-basics.html#JAX-RSBasics-URIcalculationusingUriInfoandUriBuilder       
        UriBuilder appUri = ui.getBaseUriBuilder();
        // Absolute URIs for resources we are to give provenance about
        URI helloURI = appUri.path(getClass(), "hello").build(name);        
        
        // Prepare prefixes for PROV-N qualified names
        URI appURI = appUri.build("").resolve("../");       
        URI helloPrefix = helloURI.resolve("./");
        
        // The PROV-N qualified name for our /hello/{name} resource
        String helloEntity = "hello:" + helloPrefix.relativize(helloURI);
        
        // Simple PROV-N trace, see <http://www.w3.org/TR/prov-n/>
        // Here this is done in a naive way by loading a template 
        // from src/main/resources and do string-replace to insert
        // our URIs.
        String template = IOUtils.toString(getClass().getResourceAsStream("/provTemplate.txt"));
        String prov = MessageFormat.format(template, 
                helloPrefix, appURI, helloEntity, name);
        // Note: PROV-N should be be built using say the PROV Toolbox 
        // rather than this naive template approach!
        return prov;
    }


So in order to provide the RESTful links we will need to insert *Link:*
headers in the hello() response.

